<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no user-scalable=no"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>

  <title>Smartup</title>

  <script src="assets/underscore/underscore-min.js?_=now"></script>
  <script src="assets/jquery/jquery.min.js?_=now"></script>
  <script src="assets/bootstrap/js/bootstrap.bundle.min.js?_=now"></script>

  <link rel="shortcut icon" href="favicon.ico" />
  <link href="assets/fontawesome/css/all.min.css?_=now" rel="stylesheet" type="text/css" />
  <link href="assets/metronic/css/style.bundle.css" rel="stylesheet" type="text/css" />
  <link href="biruni/login.css?_=now" rel="stylesheet" type="text/css" />
</head>
<style>
  .alternative-contact-container {
    width: 100%;
    display: flex;
    justify-content: center;
  }
  .alternative-contact {
    text-decoration: underline;
    cursor: pointer;
    font-size: 1.1rem;
    color: #1d5cff;
  }
  .alternative-contact:hover {
    color: #F3830C;
  }
</style>
<body class="background--blue--900 text--color--white--light">
  <div class="smartup-line"></div>
  <div class="login-page__top">
    <div class="login-page-language" id="langs">
      <span class="login-page-language__title"></span>
      <button type="button" class="login-page-language__button">
        <span class="login-page-language__lang">Ru</span>
        <i class="fa fa-caret-down login-page-language__caret-down"></i>
      </button>
      <div class="login-page-lang-options">
        <li code="ru">Русский</li>
        <li code="en">English</li>
        <li code="uz">Oʻzbek</li>
        <li code="kk">Қазақ</li>
        <li code="tr">Türkçe</li>
      </div>
    </div>
  </div>
  <div class="login-page__container">
    <!-- 1. entering login -->
    <div class="loginbox" id="enter_login">
      <h1 class="h3" id="recover_password"></h1>
      <p id="enter_login_message"></p>
      <form class="loginbox__form" id="submit-email">
        <div class="loginbox__inputs-container">
          <div class="loginbox__input loginbox__input--icon">
            <input id="login" autofocus/>
            <div class="loginbox__input-icon"><i class="fas fa-user"></i></div>
          </div>
        </div>
        <div class="loginbox__buttons-container">
          <button type="submit" id="recover" class="loginbox__button"></button>
          <a id="cancel" class="loginbox__button loginbox__button--transparent" href="login.html"></a>
        </div>
        <div class="loginbox__error">
          <span id="login_error1" class="text-danger">&nbsp;</span>
        </div>
      </form>
    </div>
    <!-- 2. recovering code -->
    <div class="loginbox text-center" style="display: none;" id="email_sent">
      <i class="fa fa-envelope-open-text loginbox__icon color--blue--600 text-center"></i>
      <h1 id="ready" class="h5 color--blue--600"></h1>
      <p id="recover_message"></p>
      <form class="loginbox__form" id="submit-code">
        <div class="loginbox__input loginbox__input--icon">
          <input id="code"/>
          <div class="loginbox__input-icon"><i class="fas fa-key"></i></div>
        </div>
        <div class="loginbox__buttons-container">
          <button type="submit" id="continue" class="loginbox__button"></button>
          <a id="back" class="loginbox__button loginbox__button--transparent color--blue--500" href="login.html"></a>
        </div>
        <div class="loginbox__error">
          <span id="login_error2" class="text-danger">&nbsp;</span>
        </div>
        <div class="loginbox__error">
          <span id="code_error" class="text-danger">&nbsp;</span>
        </div>
      </form>
      <div class="alternative-contact-container">
        <p class="alternative-contact" id="alternative_contact"></p>
      </div>
    </div>
    <!-- 3. (on fail) expired token -->
    <div class="loginbox" style="display: none;" id="expired_token">
      <h1 class="h5" id="expired_token_message"></h1>
    </div>
    <footer class="login-page__footer">
      <p class="text--size--small text--color--white--disabled">Copyright © 2012-<span id="current_year"></span>, Green White Solutions LLC.<br>All rights reserved. </p>
    </footer>
  </div>

<script>
$(function () {
  $('#current_year').text(new Date().getFullYear());
  var lang_code = '',
      storageKey = 'session_lang',
      token = '',
      login = '',
      send_to_phone = 'Y',
      mainContact = '',
      altContact = '';

  var recover_message = {
    en: 'A message with a 6-digit code has been sent to: <b class="color--orange--400">$1</b>',
    ru: 'Сообщение с 6-значным кодом отправлено на: <b class="color--orange--400">$1</b>',
    uz: '6 xona raqamlik kod yuborildi: <b class="color--orange--400">$1</b>',
    kk: '6 таңбалы коды бар хабарлама келесі мекенжайға жіберілді: <b class="color--orange--400">$1</b>',
    tr: '6 haneli kod içeren bir mesaj şu adrese gönderildi: <b class="color--orange--400">$1</b>'
  };

  var alternative_contact = {
    en: 'Send recovery code to: <b>$1</b>',
    ru: 'Отправить код восстановления на: <b>$1</b>',
    uz: 'Qayta tiklash kodini yuborish: <b>$1</b>',
    kk: 'Қалпына келтіру кодын жіберу: <b>$1</b>',
    tr: 'Kurtarma kodunu şuraya gönder: <b>$1</b>'
  };

  var translates = {
    recover_password: { en: 'Recover password', ru: 'Восстановление пароля', uz: 'Parolni qayta tiklash', kk: 'Құпия сөзді қалпына келтіру', tr: 'Şifre kurtarma' },
    login: { 'en': 'Login@company', 'ru': 'Логин@компания', 'uz': 'Login@kompaniya', 'kk': 'Логин@компания', 'tr': 'Login@company' },
    enter_login_message: {
      en: 'Enter your login. We will send an email to the mailbox linked to your account with further steps of recovering.',
      ru: 'Введите ваш логин. Мы отправим письмо на почтовый ящик, с которым была связана ваша учетная запись, с дальнейшими шагами по восстановлению.',
      uz: 'Loginingizni kiriting. Qayta tiklash bosqichlari uchun tizimga bog‘langan elektron pochtangizga xat yuboramiz.',
      kk: 'Логинді енгізіңіз. Біз сіздің есептік жазбаңыз байланыстырылған пошта жәшігіне қалпына келтірудің келесі қадамдарымен хат жібереміз.',
      tr: 'Giriş bilgilerinizi girin. Daha sonraki kurtarma adımları için hesabınızın ilişkili olduğu e-posta adresine bir e-posta göndereceğiz.'
    },
    recover: { 'en': 'Recover', 'ru': 'Восстановить', 'uz': 'Qayta tiklash', 'kk': 'Қалпына келтіру', tr: 'Kurtarma' },
    cancel: { 'en': 'Cancel', 'ru': 'Отмена', 'uz': 'Bekor qilish', 'kk': 'Бас тарту', tr: 'İptal etmek' },
    ready: { 'en': 'Ready!', 'ru': 'Готово!', 'uz': 'Tayyor', 'kk': 'Дайын!', tr: 'Hazır!' },
    continue: { 'en': 'Continue', 'ru': 'Продолжить', 'uz': 'Davom ettirish', 'kk': 'Жалғастыру', tr: 'Devam etmek' },
    back: { 'en': 'Back', 'ru': 'Назад', 'uz': 'Orqaga', 'kk': 'Артқа', tr: 'Geri' }
  };

  var all_langs = [
    {
      label: "Language",
      name: "ENG",
      code: "en"
    },
    {
      label: "Язык",
      name: "РУС",
      code: "ru"
    },
    {
      label: "Til",
      name: "Oʻzb",
      code: "uz"
    },
    {
      label: "Тіл",
      name: "ҚАЗ",
      code: "kk"
    },
    {
      label: "Dil",
      name: "TUR",
      code: "tr"
    }
  ];

  function escapeHtml(text) {
    let codes = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      "'": '&#39;',
      '"': '&quot;',
    };
    return String(text).replace(/[&<>'"]/g, tag => codes[tag] || tag);
  }

  function putTranslates() {
    _.each(translates, function(v, k) {
      var val = v[lang_code];

      if (k == 'login') {
        $('#' + k).attr('placeholder', val);
      } else {
        $('#' + k).text(val);
      }
    });
  }

  function setStorageLang() {
    var lang = {};
    var def_lang = navigator.language || navigator.browserLanguage || navigator.userLanguage || '';

    def_lang = def_lang.substr(0, 2).toLowerCase();

    if (!_.findWhere(all_langs, { code: def_lang })) def_lang = _.first(all_langs).code;

    if (('localStorage' in window) && window['localStorage'] !== null) {
      lang = _.findWhere(all_langs, JSON.parse(window.localStorage.getItem(storageKey)) || { code: def_lang });

      $('#langs').find('.login-page-language__title').text(lang.label + ':');
      $('#langs').find('.login-page-language__lang').text(lang.name);
      $('#langs').find('.login-page-language__button').click(function() {
        $(this).next('.login-page-lang-options').fadeToggle(100);
      });
      $('#langs').find('.login-page-lang-options>li').click(function() {
        window.localStorage.setItem(storageKey, JSON.stringify({
          code: $(this).attr('code')
        }));
        location.reload();
      });
      $('body').click(function(ev) {
        if ($(ev.target).closest('#langs').length == 0) {
          $('#langs').find('.login-page-lang-options').fadeOut(100);
        }
      });
    } else {
      $('#langs').remove();
      lang = { code: def_lang };
    }
    lang_code = lang.code;
  }

  setStorageLang();
  putTranslates();

  // ----------------------------------------------------------------------------------------------------
  function onSubmitEmail(login, to_phone) {
    if(!login) return;
    $.post('b/core/m$send_recover_password_message', { login, lang_code, send_to_phone: to_phone })
      .done(function(result) {
        $('#enter_login').hide();
        $('#email_sent').show();
        $('i.fa.fa-envelope-open-text.loginbox__icon').show();
        $('#ready').show();
        $('#recover_message').show();
        $('#recover_message').html(recover_message[lang_code].replace('$1', escapeHtml(result.main_contact)));
        if (result.alternative_contact) {
          $('#alternative_contact').html(alternative_contact[lang_code].replace('$1', escapeHtml(result.alternative_contact)));
          $('#alternative_contact').show();
        } else {
          $('#alternative_contact').text('');
          $('#alternative_contact').hide();
        }
        token = result.token;
        mainContact = result.main_contact;
        altContact = result.alternative_contact;

        $('#login_error1').html('&nbsp;');
        $('#login_error2').html('&nbsp;');
      })
      .fail(function(er) {
        $('i.fa.fa-envelope-open-text.loginbox__icon').hide();
        $('#ready').hide();
        $('#recover_message').hide();
        $('#login_error1').text(er.responseText);
        $('#login_error2').text(er.responseText);
      });
  }

  $('#submit-email').submit(function(e) {
    e.preventDefault();
    login = $('#login').val();
    onSubmitEmail(login);
  });

  $('#alternative_contact').click(function(e) {
    e.preventDefault();
    [mainContact, altContact] = [altContact, mainContact];
    send_to_phone = send_to_phone == 'Y' ? 'N' : 'Y';
    $('#alternative_contact').html(alternative_contact[lang_code].replace('$1', escapeHtml(altContact)));
    $('#alternative_contact').show();
    onSubmitEmail(login, send_to_phone);
  });

  $('#submit-code').submit(function (e) {
    e.preventDefault();
    let code = $('#code').val();
    if(code) {
      $.post('b/core/m$check_recover_password_code', { token: token, code: code, lang_code: lang_code }).done(function(result) {
        if (result.status == 'S') {
          window.location.replace('change_password.html?token=' + token + '&code=' + code);
        } else {
          $('#code_error').text(result.result);
        }
      }).fail(function(er) {
        $('#expired_token_message').text(er.responseText);
        $('#email_sent').hide();
        $('#expired_token').show();
        setTimeout(function() { window.location.replace('login.html'); }, 3000);
      });
    }
  });
});
</script>
</body>
</html>