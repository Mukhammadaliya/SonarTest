<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no user-scalable=no"/>

  <title>Smartup</title>

  <script src="assets/underscore/underscore-min.js?_=now"></script>
  <script src="assets/jquery/jquery.min.js?_=now"></script>
  <script src="assets/bootstrap/js/bootstrap.bundle.min.js?_=now"></script>

  <link rel="shortcut icon" href="favicon.ico" />
  <link href="assets/fontawesome/css/all.min.css?_=now" rel="stylesheet" type="text/css" />
  <link href="assets/metronic/css/style.bundle.css" rel="stylesheet" type="text/css" />
  <link href="biruni/login.css?_=now" rel="stylesheet" type="text/css" />
</head>
<body class="background--blue--900 text--color--white--light">
  <div class="smartup-line"></div>
  <div class="login-page__top">
    <div class="login-page-language" id="langs">
      <span class="login-page-language__title"></span>
      <button type="button" class="login-page-language__button">
        <span class="login-page-language__lang">Ru</span>
        <i class="fa fa-caret-down login-page-language__caret-down"></i>
      </button>
      <div class="login-page-lang-options">
        <li code="ru">Русский</li>
        <li code="en">English</li>
        <li code="uz">Oʻzbek</li>
        <li code="kk">Қазақ</li>
        <li code="tr">Türkçe</li>
      </div>
    </div>
  </div>
  <div class="login-page__container">
    <div class="loginbox" id="expired_token">
      <h1 class="h5" id="expired_token_message"></h1>
    </div>
    <div class="loginbox" id="enter_password" style="display: none;">
      <h1 class="h3" id="change_password"></h1>
      <p id="change_password_message"></p>
      <form class="loginbox__form">
        <div class="loginbox__inputs-container">
          <div class="loginbox__input loginbox__input--icon">
            <input id="password" type="password"  autofocus/>
            <div class="loginbox__input-icon"><i class="fas fa-eye-slash"></i></div>
          </div>
          <div class="loginbox__input loginbox__input--icon">
            <input id="confirm" type="password"/>
            <div class="loginbox__input-icon"><i class="fas fa-eye-slash"></i></div>
          </div>
        </div>
        <div class="loginbox__buttons-container">
          <button type="button" id="change" class="loginbox__button"></button>
          <a id="cancel" class="loginbox__button loginbox__button--transparent" href="login.html"></a>
        </div>
      </form>
      <div class="loginbox__error">
        <span id="incorrect_password" class="text-danger">&nbsp;</span>
      </div>
    </div>
    <div class="loginbox text-center" id="password_sent" style="display: none;">
      <h1 id="ready" class="h5 color--blue--600"></h1>
      <p id="password_sent_message"></p>
      <form class="loginbox__form">
        <div class="loginbox__buttons-container">
          <a id="back" class="loginbox__button loginbox__button--transparent color--blue--500" href="login.html"></a>
        </div>
      </form>
    </div>
    <footer class="login-page__footer">
      <p class="text--size--small text--color--white--disabled">Copyright © 2012-<span id="current_year"></span>, Green White Solutions LLC.<br>All rights reserved. </p>
    </footer>
  </div>

<script>
$(function() {
  $('#current_year').text(new Date().getFullYear());
  var lang_code = '', storageKey = location.host + ':session_lang';
  const  all_langs = [
    {
      label: "Language",
      name: "ENG",
      code: "en"
    },
    {
      label: "Язык",
      name: "РУС",
      code: "ru"
    },
    {
      label: "Til",
      name: "Oʻzb",
      code: "uz"
    },
    {
      label: "Тіл",
      name: "ҚАЗ",
      code: "kk"
    },
    {
      label: "Dil",
      name: "TUR",
      code: "tr"
    }
  ];

  var translates = {
    change_password: { 'en': 'Change password', 'ru': 'Сменить пароль', 'uz': 'Parolni oʻzgartirish', kk: 'Құпия сөзді өзгерту', tr: 'Şifre değiştir' },
    password: { 'en': 'Password', 'ru': 'Пароль', 'uz': 'Parol', kk: 'Құпия сөз', tr: 'Şifre'},
    confirm: {'en': 'Confirm password', 'ru': 'Подтвердите пароль', 'uz': 'Parolni tasdiqlang', kk: 'Құпия сөзді растаңыз', tr: 'Şifreyi Onayla' },
    change: { 'en': 'Change', 'ru': 'Изменять', 'uz': 'Oʻzgartirish', kk: 'Өзгерту', tr: 'Değiştirmek' },
    cancel: { 'en': 'Cancel', 'ru': 'Отмена', 'uz': 'Bekor qilish', kk: 'Бас тарту', tr: 'İptal etmek' },
    password_sent_message: { 'en': 'Password successfully changed.', 'ru': 'Пароль успешно изменен.', 'uz': 'Parol muvaffaqiyatli oʻzgartirildi.', kk: 'Құпия сөз сәтті өзгертілді.', tr: 'Şifre başarıyla değiştirildi.' },
    ready: { 'en': 'Ready!', 'ru': 'Готово!', 'uz': 'Tayyor!', kk: 'Дайын!', tr: 'Hazır!' },
    back: { 'en': 'Back', 'ru': 'Назад', 'uz': 'Orqaga', kk: 'Артқа', tr: 'Geri' }
  };

  var incorrect_password_message = {
    'en': 'Make sure you filled fields correctly.',
    'ru': 'Убедитесь, что вы правильно заполнили поля.',
    'uz': 'Maydonlarni to‘g‘ri to‘ldirganingizga ishonch hosil qiling.',
    'kk': 'Өрістерді дұрыс толтырғаныңызға көз жеткізіңіз.',
    'tr': 'Alanları doğru doldurduğunuzdan emin olun.'
  };

  var change_password_message = {
    'en': 'Your login is <b class="color--blue--400">$1</b>. Enter new password.',
    'ru': 'Ваш логин <b class="color--blue--400">$1</b>. Введите новый пароль.',
    'uz': 'Sizning loginingiz <b class="color--blue--400">$1</b>. Yangi parol kiriting.',
    'kk': 'Сіздің логиніңіз <b class="color--blue--400">$1</b>. Жаңа құпия сөзді енгізіңіз.',
    'tr': 'Giriş bilgileriniz <b class="color--blue--400">$1</b>. Yeni şifrenizi girin.'
  };

  function escapeHtml(text) {
    let codes = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      "'": '&#39;',
      '"': '&quot;',
    };
    return String(text).replace(/[&<>'"]/g, tag => codes[tag] || tag);
  }

  function putTranslates() {
    _.each(translates, function(v, k) {
      var val = v[lang_code];
      if (k == 'password' || k == 'confirm') {
        $('#' + k).attr('placeholder', val);
      } else {
        $('#' + k).text(val);
      }
    });
  }

  function setStorageLang() {
    var lang = {},
        def_lang = navigator.language || navigator.browserLanguage || navigator.userLanguage || '';

    def_lang = def_lang.substr(0, 2).toLowerCase();

    if (!_.findWhere(all_langs, { code: def_lang })) def_lang = _.first(all_langs).code;

    if (('localStorage' in window) && window['localStorage'] !== null) {
      lang = _.findWhere(all_langs, JSON.parse(window.localStorage.getItem(storageKey)) || { code: def_lang });

      $('#langs').find('.login-page-language__title').text(lang.label + ':');
      $('#langs').find('.login-page-language__lang').text(lang.name);
      $('#langs').find('.login-page-language__button').click(function() {
        $(this).next('.login-page-lang-options').fadeToggle(100);
      });
      $('#langs').find('.login-page-lang-options>li').click(function() {
        window.localStorage.setItem(storageKey, JSON.stringify({
          code: $(this).attr('code')
        }));
        location.reload();
      });
      $('body').click(function(ev) {
        if ($(ev.target).closest('#langs').length == 0) {
          $('#langs').find('.login-page-lang-options').fadeOut(100);
        }
      });
    } else {
      $('#langs').remove();
      lang = { code: def_lang };
    }
    lang_code = lang.code;
  }

  setStorageLang();

  var url = new URL(window.location.href);
  var token = url.searchParams.get('token') || '';
  var code = url.searchParams.get('code') || '';

  function throwToLoginPage(error_text) {
    $('#expired_token_message').text(error_text);
    setTimeout(function() { window.location.replace('login.html'); }, 3000);
  }

  $.post('b/core/m$check_recover_password_code', { token: token, code: code, lang_code: lang_code }).done(function(result) {
    if (result.status == 'S') {
      putTranslates();
      $('#expired_token').hide();
      $('#enter_password').show();
      $('#change_password_message').html(change_password_message[lang_code].replace('$1', escapeHtml(result.result)));
    } else {
      throwToLoginPage(result.result);
    }
  }).fail(function(er) {
      throwToLoginPage(er.responseText);
  });

  var input_type = 'password',
      icon_class = 'fas fa-eye-slash';

  $('.loginbox__input-icon').click(function() {
    if (input_type == 'password') {
      input_type = 'text';
      icon_class = 'fas fa-eye';
    } else {
      input_type = 'password';
      icon_class = 'fas fa-eye-slash';
    }
    $('input').attr('type', input_type);
    _.each($('.loginbox__input-icon'), function(el) {
      $(el.firstChild).attr('class', icon_class);
    });
  });

  function changePassword() {
    var password = $('#password').val(),
        confirm = $('#confirm').val();

    if (password == confirm && password) {
      $.post('b/core/m$change_password', { password: password, token: token, code: code }).done(function() {
        $('#enter_password').hide();
        $('#password_sent').show();
      }).fail(function(er) {
        $('#expired_token_message').text(er.responseText);
        $('#enter_password').hide();
        $('#expired_token').show();
        setTimeout(function() { window.location.replace('login.html'); }, 3000);
      });
    } else {
      $('#incorrect_password').text(incorrect_password_message[lang_code]);
    }
  }

  $('#password').keypress(function(act) {
    if(act.charCode == 13) {
      $('#confirm').focus();
    }
  });

  $('#confirm').keypress(function(act) {
    if(act.charCode == 13) {
      changePassword();
    }
  });

  $('#change').click(function() {
    changePassword();
  });
});
</script>
</body>
</html>